<%- include("_header") -%>

<main class="container mt-4">
  <h1>Inscrição para Mutirão de Castração</h1>
  <p class="text-muted">Preencha os dados do tutor e dos animais. Campos marcados com * são obrigatórios.</p>

  <form id="mutiraoForm" action="/castracao/mutirao/create" method="POST" class="row g-3">
    <input type="hidden" name="calendario_id" value="<%= typeof formData !== 'undefined' ? formData.calendario_id || '' : '' %>">
    <div class="col-md-6">
      <label class="form-label">Nome do Tutor*</label>
      <input type="text" name="tutor_nome" class="form-control" value="<%= formData.tutor_nome || '' %>" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Contato (telefone/email)</label>
      <input type="text" name="tutor_contato" class="form-control" value="<%= formData.tutor_contato || '' %>">
    </div>
    <div class="col-md-3">
      <label class="form-label">Vagas solicitadas</label>
      <input type="number" name="vagas_solicitadas" class="form-control" value="1" min="1">
    </div>
    <div class="col-12">
      <label class="form-label">Animais (adicione um por vez)</label>
      <div id="animaisList"></div>
      <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="addAnimal">Adicionar Animal</button>
    </div>

    <input type="hidden" name="animais_json" id="animais_json">

    <div class="col-12 d-flex justify-content-end mt-3">
      <a href="/castracao" class="btn btn-outline-secondary me-2">Cancelar</a>
      <button type="submit" class="btn btn-primary">Enviar Inscrição</button>
    </div>
  </form>

</main>

<script>
  // Simple dynamic animals list
  const animais = [];
  const animaisList = document.getElementById('animaisList');
  const animaisJson = document.getElementById('animais_json');

  function renderAnimais(){
    animaisList.innerHTML = '';
    animais.forEach((a,i)=>{
      const div = document.createElement('div');
      div.className = 'card p-2 mb-2';
      div.innerHTML = `<div class="row g-2">
        <div class="col-md-2"><input class="form-control" placeholder="Gênero" value="${a.genero||''}" data-i="${i}" data-key="genero"></div>
        <div class="col-md-3"><input class="form-control" placeholder="Nome" value="${a.nome||''}" data-i="${i}" data-key="nome"></div>
        <div class="col-md-2"><input class="form-control" placeholder="Idade" value="${a.idade||''}" data-i="${i}" data-key="idade"></div>
        <div class="col-md-2"><input class="form-control" placeholder="Peso" value="${a.peso||''}" data-i="${i}" data-key="peso"></div>
        <div class="col-md-2"><input class="form-control" placeholder="Medicamentos" value="${a.medicamentos||''}" data-i="${i}" data-key="medicamentos"></div>
        <div class="col-md-1 text-end"><button class="btn btn-sm btn-danger" data-index="${i}" type="button">Rem</button></div>
      </div>`;
      animaisList.appendChild(div);
    });
    // attach events
    animaisList.querySelectorAll('input[data-i]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = e.target.getAttribute('data-i');
        const k = e.target.getAttribute('data-key');
        animais[i][k] = e.target.value;
      });
    });
    animaisList.querySelectorAll('button[data-index]').forEach(btn=> btn.addEventListener('click', e=>{ animais.splice(parseInt(e.target.getAttribute('data-index')),1); renderAnimais(); }));
    animaisJson.value = JSON.stringify(animais);
  }

  document.getElementById('addAnimal').addEventListener('click', ()=>{ animais.push({genero:'',nome:'',idade:'',peso:'',vacinado:false,medicamentos:''}); renderAnimais(); });
  document.getElementById('mutiraoForm').addEventListener('submit', ()=>{ animaisJson.value = JSON.stringify(animais); });
  // initial
  renderAnimais();
</script>

<%- include("_footer") -%>
