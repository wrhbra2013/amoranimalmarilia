<%- include("_header") -%>

<main class="main-content">
  <div class="container py-5">
    <% if (evento) { %>
      <div class="row justify-content-center">
        <div class="col-md-8">
          <h1 class="mb-3"><%= evento.titulo %></h1>
          <% if (evento.data_evento) { %>
            <p class="text-muted">Data: <%= evento.data_evento.toISOString ? evento.data_evento.toISOString().slice(0,10) : evento.data_evento %></p>
          <% } %>
          <% if (evento.descricao) { %>
            <div class="event-description mb-3"><%- evento.descricao.replace(/\n/g, '<br>') %></div>
          <% } %>

          <% if (fotos && fotos.length > 0) { %>
            <div class="event-gallery">
              <!-- Carrossel Principal -->
              <div class="evt-carousel-wrapper">
                <div id="evtFeaturedInner" class="evt-carousel-inner">
                  <% fotos.forEach(function(f, i) { %>
                    <div class="evt-feature-slide <%= i===0 ? 'active' : '' %>" data-index="<%= i %>">
                      <% if (isAdmin) { %>
                        <form action="/eventos/foto/delete/<%= f.id %>" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir esta foto?');" class="evt-delete-btn">
                          <button type="submit" class="btn btn-danger btn-sm rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;" title="Excluir foto">
                            <i class="fas fa-times"></i>
                          </button>
                        </form>
                      <% } %>
                      <img class="featured-image" loading="lazy" src="/uploads/eventos/<%= f.arquivo %>" alt="Foto <%= i+1 %>">
                      <div class="evt-caption-data d-none"><%= f.descricao || '' %></div>
                    </div>
                  <% }); %>
                  <button id="evtPrev" class="evt-nav-btn prev" aria-label="Anterior"><i class="fas fa-chevron-left"></i></button>
                  <button id="evtNext" class="evt-nav-btn next" aria-label="Próximo"><i class="fas fa-chevron-right"></i></button>
                </div>
                
                <!-- Descrição fora do card -->
                <div id="evtDescription" class="text-center mt-2 px-3 text-muted fst-italic" style="min-height: 1.5em;">
                  <%= fotos[0] ? fotos[0].descricao : '' %>
                </div>

                <div id="evtCount" class="text-center text-muted small mt-2">1 / <%= fotos.length %></div>
              </div>

              <!-- Miniaturas -->
              <div id="evtThumbs" class="mt-3">
                <% fotos.forEach(function(f, i) { %>
                  <div class="evt-thumb <%= i===0 ? 'active' : '' %>" data-index="<%= i %>">
                    <img src="/uploads/eventos/<%= f.arquivo %>" alt="thumb <%= i+1 %>">
                  </div>
                <% }); %>
              </div>
            </div>
          <% } else { %>
            <p class="text-muted">Nenhuma foto enviada para este evento.</p>
          <% } %>

          <% if (isAdmin) { %>
            <div class="mt-3 d-flex gap-2">
              <a href="/eventos/<%= evento.id %>/adicionar-foto" class="button btn-sm">Adicionar foto</a>
              <!-- <a href="#" class="btn btn-link btn-sm" onclick="document.getElementById('foto').click(); return false;">Enviar foto rápida</a> -->
            </div>
            <noscript><p class="small text-muted">Use a página de adicionar foto para enviar imagens quando JavaScript estiver desabilitado.</p></noscript>
          <% } %>

          <div class="mt-3">
            <a href="/" class="button btn-secondary">Voltar</a>
          </div>
          
          <hr class="my-5">

          <!-- Seção de Comentários -->
          <div class="comments-section">
           
            
            
            <!-- Lista de Comentários -->
            <% if (typeof comments !== 'undefined' && comments.length > 0) { %>
              <div class="list-group" >
                <% comments.forEach(function(c) { %>
                  
                  <div class="list-group-item list-group-item-action flex-column align-items-start" >
                    <div class="d-flex w-100 justify-content-between">
                       <p class="mb-1 text-break"><%= c.comentario %></p> 
                      <h6 class="mb-1 fw-bold"><%= c.nome || 'Anônimo' %></h6>
                      <small class="text-muted"><%= c.created_at ? new Date(c.created_at).toLocaleDateString('pt-BR') + ' às ' + new Date(c.created_at).toLocaleTimeString('pt-BR') : '' %></small>
                    </div>
                   
                <% }); %>
              </div>
              <hr>
            <% } else { %>
              <p class="text-muted fst-italic">Nenhum comentário ainda. Seja o primeiro a comentar!</p>
            <% } %>
          </div>

          <!-- Formulário -->
            <div class="card mb-4 shadow-sm">
              <div class="card-body">
                <h5 class="card-title mb-3">Deixe seu comentário</h5>
                <form action="/eventos/<%= evento.id %>/comment" method="POST">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <input type="text" class="form-control" id="nome" name="nome" placeholder="Seu nome">
                    </div>
                    <div class="col-md-7">
                      <textarea class="form-control" id="comentario" name="comentario" rows="1" required placeholder="Escreva seu comentário aqui..." style="resize:none; height: 38px;"></textarea>
                    </div>
                    <div class="col-md-2">
                      <button type="submit" class="button btn-sm w-100">Enviar</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
        </div>
      </div>
    <% } else { %>
      <p class="text-center text-muted">Evento não encontrado.</p>
    <% } %>
  </div>
</main>

<link rel="stylesheet" href="/static/css/eventos_view.css">
<%- include("_footer") -%>

<script src="/static/js/eventos_view.js"></script>

